name: Deploy backend

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -e
            PROJECT_PATH=${PROJECT_PATH:-/var/www/vendplug-backend}
            PM2_NAME=${PM2_NAME:-vendplug-api}
            REPO_URL="https://github.com/Daroahmed/vendplug-backend.git"

            echo "üöÄ Starting deployment..."
            echo "üìÅ Project path: $PROJECT_PATH"
            echo "üîß PM2 name: $PM2_NAME"

            # Create directory if it doesn't exist
            if [ ! -d "$PROJECT_PATH" ]; then
              echo "üìÇ Creating project directory: $PROJECT_PATH"
              mkdir -p "$PROJECT_PATH" || {
                echo "‚ö†Ô∏è  Failed to create directory (may need sudo or different path)"
                echo "üí° Trying with sudo..."
                sudo mkdir -p "$PROJECT_PATH" && sudo chown -R $USER:$USER "$PROJECT_PATH" || {
                  echo "‚ùå Cannot create directory. Please create $PROJECT_PATH manually with proper permissions."
                  exit 1
                }
              }
            fi

            # Navigate to project directory
            cd "$PROJECT_PATH" || {
              echo "‚ùå Failed to change directory to $PROJECT_PATH"
              exit 1
            }

            # Initialize git repo if it doesn't exist
            if [ ! -d ".git" ]; then
              echo "üì¶ Initializing git repository..."
              git init
              git remote add origin "$REPO_URL" || git remote set-url origin "$REPO_URL"
              git fetch origin
              git checkout -b main origin/main || git checkout -t origin/main || true
            else
              echo "üîÑ Syncing code from repository..."
              # Ensure remote is set correctly
              git remote set-url origin "$REPO_URL" 2>/dev/null || git remote add origin "$REPO_URL"
              # Fetch and reset
              git fetch --all --prune || {
                echo "‚ö†Ô∏è  Git fetch failed, trying to reset remote..."
                git remote set-url origin "$REPO_URL"
                git fetch --all --prune
              }
              git reset --hard origin/main || {
                echo "‚ùå Failed to reset to origin/main"
                exit 1
              }
              git clean -fd
            fi

            echo "üì• Installing dependencies..."
            # Install deps (lock + fallback)
            if [ -f "package-lock.json" ]; then
              npm ci --omit=dev || npm install --omit=dev
            else
              npm install --omit=dev
            fi

            echo "üîÑ Managing PM2 process..."
            # Check if PM2 is installed
            if ! command -v pm2 &> /dev/null; then
              echo "‚ùå PM2 is not installed. Please install PM2 first: npm install -g pm2"
              exit 1
            fi

            # Restart with env
            if pm2 describe "$PM2_NAME" >/dev/null 2>&1; then
              echo "‚ôªÔ∏è  Restarting existing PM2 process: $PM2_NAME"
              pm2 restart "$PM2_NAME" --update-env
            else
              echo "üÜï Starting new PM2 process: $PM2_NAME"
              pm2 start server.js --name "$PM2_NAME" --cwd "$PROJECT_PATH"
            fi
            pm2 save

            echo "‚è≥ Waiting for server to start..."
            sleep 5

            echo "üè• Running health check..."
            # Local health check (backend port)
            if curl -fsS http://127.0.0.1:5000/ | grep -q 'Backend is running'; then
              echo "‚úÖ Health check passed! Deployment successful."
            else
              echo "‚ö†Ô∏è  Health check failed, but deployment completed."
              echo "üí° Check PM2 logs: pm2 logs $PM2_NAME"
              # Don't exit with error, as the server might need more time
            fi

            echo "‚ú® Deployment completed!"
